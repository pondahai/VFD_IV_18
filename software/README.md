# IV-18 VFD 網路電子鐘與計算機

這是一個基於 ESP8266 微控制器，驅動前蘇聯製 IV-18 型真空螢光顯示管（VFD）的專案。它不僅是一個精準的時鐘，還內建了一個功能強大的網頁伺服器，讓使用者可以透過 Wi-Fi 連線，將其當作一個即時顯示的計算機或文字訊息看板。

### 核心功能

*   **IV-18 VFD 顯示**：使用輝光效果迷人的 IV-18 真空管作為顯示器，可顯示 8 位數字或字母。
*   **ESP8266 主控**：利用 ESP8266 強大的處理能力和內建的 Wi-Fi 功能。
*   **DS3231 即時時鐘 (RTC)**：配備高精度的 DS3231 硬體時鐘模組，確保在斷電後仍能保持準確的時間。
*   **Wi-Fi AP 模式與強制門戶 (Captive Portal)**：
    *   裝置啟動後會建立一個名為 `ESP_VFD_Clock` 的 Wi-Fi 熱點。
    *   使用者連上此 Wi-Fi 後，裝置會利用強制門戶技術，自動將手機或電腦的瀏覽器導向控制頁面，無需輸入 IP 位址。
*   **多功能網頁控制介面**：
    *   **時鐘同步**：點擊 "時鐘" 按鈕，即可將您手機或電腦的當前時間同步到裝置的硬體 RTC 中。
    *   **自訂文字顯示**：在輸入框中輸入文字並點擊 "傳送"，VFD 螢幕會立即顯示您輸入的內容。若文字超過 8 個字元，會自動啟用滾動顯示效果。
    *   **即時計算機**：網頁內建一個功能完整的計算機。您在計算機上進行的每一步操作和最終結果，都會即時顯示在 VFD 螢幕上。
*   **聲音回饋**：當有裝置連上或斷開 Wi-Fi 熱點時，會播放提示音。

### 硬體需求

*   **ESP8266 開發板** (如 NodeMCU, Wemos D1 Mini)
*   **IV-18 真空螢光顯示管**
*   **DS3231 即時時鐘模組** (I2C 介面)
*   **74HC595 移位暫存器** (或其他 VFD 驅動晶片，用於控制 VFD 的柵極和段極)
*   **高壓電源模組** (用於提供 VFD 所需的電壓)
*   **被動式蜂鳴器** (用於聲音回饋)
*   相關的電阻、電容和 PCB 板

### 軟體與函式庫

*   **Arduino IDE** 或 **PlatformIO**
*   **ESP8266 Core for Arduino**
*   `ESP8266WiFi.h`
*   `ESP8266WebServer.h`
*   `DNSServer.h`
*   `RTClib.h` (Adafruit RTC library)
*   `Wire.h` (用於 I2C 通訊)

### 運作流程

1.  **啟動與初始化**：
    *   裝置上電後，ESP8266 開始執行 `setup()` 函式。
    *   初始化序列埠通訊、I/O 腳位。
    *   透過 I2C 介面檢查 DS3231 RTC 模組是否正常連接。如果找不到 RTC，裝置會不斷重啟。
    *   初始化 VFD 顯示器，進行一次簡單的清屏。

2.  **建立 Wi-Fi 網路**：
    *   ESP8266 設定為 `WIFI_AP` (無線基地台) 模式。
    *   建立一個 SSID 為 `ESP_VFD_Clock`，密碼為 `00000000` 的開放 Wi-Fi 網路。
    *   啟動 DNS 伺服器和網頁伺服器，為強制門戶做準備。

3.  **使用者互動**：
    *   使用者使用手機或電腦搜尋並連接到 `ESP_VFD_Clock` Wi-Fi。
    *   連接成功後，作業系統會偵測到這是一個需要登入的網路，並自動彈出瀏覽器頁面，該頁面就是由 ESP8266 提供的控制介面 (`responseHTML`)。
    *   **若無人連接**：在沒有任何裝置連接的情況下，VFD 會自動顯示 DS3231 RTC 提供的當前時間（格式為 `時 時 分 分 秒 秒`）。
    *   **當有裝置連接後**：
        *   **時鐘同步**：使用者點擊 "時鐘" 按鈕，瀏覽器的 JavaScript 會獲取當前系統時間，並透過 `GET` 請求（例如 `/clock/2023-10-27T10:30:00`）發送給 ESP8266。ESP8266 收到後解析此字串，並更新 DS3231 的時間。
        *   **文字/計算機顯示**：使用者在文字框輸入內容或操作計算機，JavaScript 會將要顯示的字串（例如 `HELLO` 或 `123.45`）透過 `GET` 請求（例如 `/text/HELLO`）發送給 ESP8266。ESP8266 更新 `serialData` 變數，主迴圈 `loop()` 偵測到此變數更新後，會立即將內容顯示在 VFD 上。

4.  **顯示驅動 (主迴圈 `loop()`)**：
    *   `loop()` 函式以極快的速度不斷循環。
    *   它採用 **多工掃描 (Multiplexing)** 的方式驅動 VFD。在每一次循環中，只點亮 8 個數位中的 **一個**。
    *   透過快速切換要點亮的數位（從第 7 位到第 0 位），利用人眼的視覺暫留效應，看起來就像所有數位都同時亮著。
    *   `iv18_digit()` 函式負責將指定的字元（如 'A' 或 '5'）轉換成對應的段碼（Segment Code），並連同位選碼（Grid Code）一起透過 `shiftOut()` 函式發送到 74HC595 移位暫存器，從而精確控制 VFD 的顯示。

### 如何使用

1.  **為裝置通電**。
2.  在您的手機或電腦上，**開啟 Wi-Fi 設定**，找到並連接到名為 `ESP_VFD_Clock` 的網路。
3.  系統應該會**自動彈出一個登入頁面**。如果沒有，請手動打開瀏覽器訪問任意網址（例如 `http://a.com`）。
4.  您會看到控制介面：
    *   若要校準時間，請點擊 **[時鐘]** 按鈕。
    *   若要顯示文字，請在頂部輸入框輸入，然後點擊 **[傳送]**。
    *   使用下方的**計算機**，其運算過程和結果將即時顯示在 VFD 螢幕上。
5.  當您斷開 Wi-Fi 連接後，VFD 螢幕將自動切換回時間顯示模式。
